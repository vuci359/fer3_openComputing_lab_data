<!DOCTYPE html>
<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="./jquery.dataTables.min.css" />
    <link rel="stylesheet" href="./datatable.css" />
    <script type="text/javascript" charset="utf8" src="./jquery.min.js"></script>
    <script type="text/javascript" charset="utf8" src="./jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="./dataTables.buttons.min.js"></script>
    <script type="text/javascript" charset="utf8" src="./buttons.html5.min.js"></script>



</head>
<body>
    <h1>Datatable</h1>
    <table class="inputs"><tbody>
        <tr>
            <td class="filteri">Polje za pretragu</td>
            <td><input type="text" Value="Unesite vrijednost" id="pretraga" name="pretraga"/></td>
        </tr>
        <tr>
            <td class="filteri">
                <label for="atribut">Odaberite polje za pretragu:</label>
            <select id="atribut" name="atrinut">
              <option value=0>song name</option>
              <option value=1>band name</option>
              <option value=2>band members</option>
              <option value=3>genre</option>
              <option value=4>album name</option>
              <option value=5>album label</option>
              <option value=6>album release date</option>
              <option value=7>song length</option>
              <option value=8>position on album</option>
              <option value=9>lyrics writers</option>
              <option value=10>music writers</option>
              <option value=11>lyrics</option>
              <option value=12>*</option>
            </select>
            </td>
        </tr>
        <tr>
            <td class="filteri">
                <input type="submit" id="gumb" value="Submit">
            </td>
        </tr>
    </tbody></table>
    <table id="tablica" class="display">
        <thead>
            <tr>
                <th>song name</th>
                <th>band name</th>
                <th>band members</th>
                <th>genre</th>
                <th>album name</th>
                <th>album label</th>
                <th>album release date</th>
                <th>song length</th>
                <th>position on album</th>
                <th>lyrics writers</th>
                <th>music writers</th>
                <th>lyrics</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <a href="./index.html">Index</a>
</body>


<script>
var json_data = null;
/*
function format(d) {
    concole.log(e);
    // `d` is the original data object for the row
    return (
        '<dl>' +
        '<dt>Song name:</dt>' +
        '<dd>' +
        d."song name" +
        '</dd>' +
        '<dt>Genre:</dt>' +
        '<dd>' +
        d.genre +
        '</dd>' +
        '<dt>Extra info:</dt>' +
        '<dd>And any further details here (images etc)...</dd>' +
        '</dl>'
    );
}
*/
var data_table = $('#tablica').DataTable({
        "data": null,
        "columns": [
            { "data": "song name" },
            { "data": "band name" },
            { "data": "band members" },
            { "data": "genre" },
            { "data": "album name" },
            { "data": "album label" },
            { "data": "album release date" },
            { "data": "song length" },
            { "data": "position on album" },
            { "data": "lyrics writers" },
            { "data": "music writers" },
            { "data": "lyrics" }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                text: 'Preuzmi JSON',
                id:"get_json",
                action: function ( e, dt, button, config ) {
                    var data = dt.buttons.exportData();
                    console.log(data);
                    $.fn.dataTable.fileSave(
                        new Blob( [ JSON.stringify( data ) ] ),
                        'Export.json'
                    );
                }
                
            },
            {
                text: 'Preuzmi CSV',
                id:"get_csv",
                exportOptions: {
                modifier: {
                    search: 'none'
                }
            }
            }
        ]
    });

//punjenje tablice
async function fill_table(){
    //učitavanje podataka
    await getData();
    //punjenje tablice
    data_table.clear();
    data_table.rows.add(json_data.podaci).draw();
}

const search_term = document.querySelector("#pretraga");
const search_category = document.querySelector("#atribut");

$('#gumb').on('click', function () {
    console.log(search_category.value);
    console.log(search_term.value);
    data_table.clear();
    data_table.rows.add(json_data.podaci).draw()
    if(search_term.value != "*"){    
        if(search_category.value == 12){
            data_table
            .search(search_term.value)
            .draw();
        }
        else{
            data_table
            .column(search_category.value)
            .search(search_term.value)
            .draw();
        }
    }
} );

// output: {"success":"true"}
async function getData(){
      
         return await fetch('http://localhost:8087' + '/api/HeavyMetalData/GetData',{
            method: 'GET',
            mode:'cors',
            headers:{
                'Access-Control-Allow-Origin': 'true',
                'Sec-Fetch-Mode': 'cors'
            },
            data: jQuery.param({stupac:"music writers", parameter:"James Hetfield"}),
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8'
        }).then(response => {
             if (response.status >= 200 && response.status < 300) {
               // console.log("aaa");
             //   console.log(response.body);
              //  console.log("bbb");
                return response;
            } else {
                console.log('Something happened wrong');
                console.log(response.body);
               }
         }).then(res => res.json()).then(data => {
              //  console.log("zzz");
               //console.log(data);
                json_data = data;
         }).catch(err => err);
}
/*
// Add event listener for opening and closing details
data_table.on('click', 'td.dt-control', function (e) {
    let tr = e.target.closest('tr');
    let row = data_table.row(tr);
 
    if (row.child.isShown()) {
        // This row is already open - close it
        row.child.hide();
    }
    else {
        // Open this row
        row.child(format(row.data())).show();
    }
});
*/
fill_table();
</script>